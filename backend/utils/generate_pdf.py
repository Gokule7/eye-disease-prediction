from fpdf import FPDF
import datetime
import os

class PDFReport(FPDF):
    def header(self):
        self.set_font('Arial', 'B', 14)
        self.cell(0, 10, 'VisionCare Eye Center - Test Result Certificate', ln=True, align='C')
        self.set_font('Arial', '', 11)
        self.cell(0, 8, 'AI-Powered Eye Disease Diagnostic Report', ln=True, align='C')
        self.ln(5)

    def footer(self):
        self.set_y(-15)
        self.set_font('Arial', 'I', 8)
        self.cell(0, 10, f'Report generated on {datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")}', 0, 0, 'C')

def generate_pdf_report(patient_name, email, left_image, right_image, prediction_dict, final_diagnosis, save_path):
    pdf = PDFReport()
    pdf.add_page()

    pdf.set_font('Arial', '', 12)

    # üë§ Patient Information
    pdf.cell(0, 10, f"Patient Name : {patient_name}", ln=True)
    pdf.cell(0, 10, f"Email        : {email}", ln=True)
    pdf.cell(0, 10, f"Final Diagnosis: {final_diagnosis}", ln=True)
    pdf.ln(8)

    # üìà Prediction Probabilities
    pdf.set_font('Arial', 'B', 12)
    pdf.cell(0, 10, 'Prediction Probabilities:', ln=True)
    pdf.set_font('Arial', '', 12)
    for disease, prob in prediction_dict.items():
        pdf.cell(0, 8, f'{disease}: {prob:.2f}%', ln=True)

    pdf.ln(10)

    # üñºÔ∏è Eye Images (filenames)
    if left_image:
        pdf.cell(0, 10, f'Left Eye Image: {os.path.basename(left_image)}', ln=True)
    if right_image:
        pdf.cell(0, 10, f'Right Eye Image: {os.path.basename(right_image)}', ln=True)

    pdf.ln(20)
    pdf.set_font('Arial', 'I', 10)
    pdf.multi_cell(0, 8, 'Note: This report is generated by a machine learning-based system for assisting diagnosis. Please consult an ophthalmologist for final evaluation.')

    # Save the report
    pdf.output(save_path)

    return save_path
